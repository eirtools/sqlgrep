---
name: Cache Cargo Dependencies
inputs:
  cache-key:
    description: Cache key to use for cargo home
    required: false
    default: cargo-cache
  cache-target-key:
    description: Cache key to use for target
    required: false
    default: cargo-target
  additional_home:
    description: Additional rules for cargo home caching
    required: false
  additional_target:
    description: Additional rules for target folder
    required: false
runs:
  using: composite
  steps:
    # Cache the global cargo directory, but NOT the local `target` directory which
    # we cannot reuse anyway when the nightly changes (and it grows quite large
    # over time).

    # It will be saved every time, thus just use primary key only.

  - name: Add cache for cargo
    id: cache
    uses: actions/cache@v5
    with:
      path: |
        # List is taken from <https://doc.rust-lang.org/nightly/cargo/guide/cargo-home.html#caching-the-cargo-home-in-ci>.
        ~/.cargo/bin
        ~/.cargo/registry/index
        ~/.cargo/registry/cache
        ~/.cargo/git/db
        # contains package information of crates installed via `cargo install`.
        ~/.cargo/.crates.toml
        ~/.cargo/.crates2.json
        ${{ inputs.additional_home }}
      key: ${{ runner.os }}-${{ inputs.cache-key }}-${{ hashFiles('Cargo.lock', 'Cargo.toml', '.github/ci-tools.toml', '.cargo/config.toml') }}
      lookup-only: ${{ env.LOOKUP_CARGO_HOME }}
  - name: cache target
    uses: actions/cache@v5
    with:
      path: |
        # Cache target, but not temporary folders
        target
        !target/llvm-cov*
        !target/nextest
        !target/package
        !target/tmp
        ${{ inputs.additional_target }}
      key: ${{ runner.os }}-${{ inputs.cache-target-key }}-${{ hashFiles('Cargo.lock', 'Cargo.toml', '.github/ci-tools.toml', '.cargo/config.toml') }}
      lookup-only: ${{ env.LOOKUP_TARGET }}
